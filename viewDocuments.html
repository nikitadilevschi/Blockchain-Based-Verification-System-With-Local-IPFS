<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>View Uploaded Documents</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  </head>
  <body>
    <div class="container my-4">
      <h3 class="text-center mb-4">Uploaded Documents</h3>
      <div id="documentsList" class="list-group">
        <!-- Document items will be injected here -->
      </div>
    </div>
    
    <!-- Load dependencies -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Load Web3 and your App.js -->
    <script src="web3.min.js"></script>
    <script
      src="https://code.jquery.com/jquery-3.6.0.js"
      integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk="
      crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Bootstrap framework -->
    <script src="./js/purecounter.min.js"></script>
    <script src="./js/aos.js"></script>
    <script src="./js/script.js"></script>
    <script src="./js/App.js"></script>

    <script>
      window.addEventListener('load', async () => {
        // Check for Metamask
        if (typeof window.ethereum !== 'undefined') {
          window.web3 = new Web3(window.ethereum);
          await window.ethereum.enable();
          // Make sure your App.js has initialized window.contract properly
          loadDocuments();
        } else {
          alert("Please install MetaMask to view documents.");
        }
      });

      async function loadDocuments() {
        try {
          // Query all past addHash events
          const events = await window.contract.getPastEvents("addHash", {
            fromBlock: 0,
            toBlock: "latest"
          });
          console.log("Document events:", events);
          updateDocumentsUI(events);
        } catch (error) {
          console.error("Error loading documents:", error);
        }
      }

      function updateDocumentsUI(events) {
        const listContainer = document.getElementById("documentsList");
        listContainer.innerHTML = ""; // Clear previous items
        if (events.length === 0) {
          listContainer.innerHTML = "<p class='text-center'>No documents found.</p>";
          return;
        }
        // Loop over events and create list items
        events.forEach(event => {
          // The event returns _exporter and _ipfsHash (as defined in the event)
          const exporter = event.returnValues._exporter;
          const ipfsHash = event.returnValues._ipfsHash;
          // Create a clickable item (optionally you could link to your IPFS gateway)
          const item = document.createElement("a");
          item.href = `http://127.0.0.1:8080/ipfs/${ipfsHash}`; // or your own IPFS gateway
          item.target = "_blank";
          item.className = "list-group-item list-group-item-action";
          item.innerHTML = `
            <p><strong>Exporter:</strong> ${exporter}</p>
            <p><strong>IPFS Hash:</strong> ${ipfsHash}</p>
          `;
          listContainer.appendChild(item);
        });
      }
    </script>
  </body>
  <script src="node_modules/web3/dist/web3.min.js"></script>
</html>
